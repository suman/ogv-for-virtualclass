!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,b.StreamFile=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},i=a("./download-backend.js"),j="arraybuffer",k=function(a){function b(){return d(this,b),e(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return f(b,a),g(b,[{key:"initXHR",value:function(){h(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"initXHR",this).call(this),this.xhr.responseType=j}},{key:"onXHRProgress",value:function(){}},{key:"onXHRLoad",value:function(){var a=this.xhr.response;this.bytesRead+=a.byteLength,this.emit("buffer",a),h(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"onXHRLoad",this).call(this)}}]),b}(i);k.supported=function(){try{var a=new XMLHttpRequest;return a.responseType=j,a.responseType===j}catch(a){return!1}},b.exports=k},{"./download-backend.js":4}],2:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function g(a){if(206==a.status)return j(a);var b=a.getResponseHeader("Content-Length");return null===b||""===b?-1:parseInt(b,10)}function h(a){var b=a.getResponseHeader("Content-Range");return b&&b.match(/^bytes (\d+)-(\d+)\/(\d+)/)}function i(a){var b=h(a);return b?parseInt(b[1],10):0}function j(a){var b=h(a);return b?parseInt(b[3],10):-1}function k(a){var b={},c=a.getAllResponseHeaders().split(/\r?\n/);return c.forEach(function(a){var c=a.split(/:\s*/,2);c.length>1&&(b[c[0].toLowerCase()]=c[1])}),b}var l=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),m=a("../events"),n=function(a){function b(a){var c=a.url,f=a.offset,g=a.length,h=a.cachever,i=void 0===h?0:h;d(this,b);var j=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return j.url=c,j.offset=f,j.length=g,j.cachever=i,j.loaded=!1,j.seekable=!1,j.headers={},j.eof=!1,j.bytesRead=0,j.xhr=new XMLHttpRequest,j}return f(b,a),l(b,[{key:"load",value:function(){var a=this;return new Promise(function(b,c){var d=null;a._onAbort=function(a){d(),c(a)};var e=function(){if(2==a.xhr.readyState){if(206==a.xhr.status){var e=i(a.xhr);if(a.offset!=e)return console.log("Expected start at "+a.offset+" but got "+e+"; working around Safari range caching bug: https://bugs.webkit.org/show_bug.cgi?id=82672"),a.cachever++,a.emit("cachever"),a.abort(),d(),void a.load().then(b).catch(c);a.seekable=!0}a.xhr.status>=200&&a.xhr.status<300?(a.length=g(a.xhr),a.headers=k(a.xhr),a.onXHRStart()):(d(),c(new Error("HTTP error "+a.xhr.status)))}},f=function(){d(),c(new Error("network error"))},h=function(){d(),b()};d=function(){a.xhr.removeEventListener("readystatechange",e),a.xhr.removeEventListener("error",f),a.off("open",h),a._onAbort=null},a.initXHR(),a.xhr.addEventListener("readystatechange",e),a.xhr.addEventListener("error",f),a.on("open",h),a.xhr.send()})}},{key:"bufferToOffset",value:function(a){return Promise.reject(new Error("abstract"))}},{key:"abort",value:function(){if(this.xhr.abort(),this._onAbort){var a=this._onAbort;this._onAbort=null;var b=new Error("Aborted");b.name="AbortError",a(b)}}},{key:"initXHR",value:function(){var a=this.url;this.cachever&&(a+="?buggy_cachever="+this.cachever),this.xhr.open("GET",a);var b=null;(this.offset||this.length)&&(b="bytes="+this.offset+"-"),this.length&&(b+=this.offset+this.length-1),null!==b&&this.xhr.setRequestHeader("Range",b)}},{key:"onXHRStart",value:function(){throw new Error("abstract")}}]),b}(m);b.exports=n},{"../events":11}],3:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},i=a("./download-backend.js"),j=function(a){function b(){return d(this,b),e(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return f(b,a),g(b,[{key:"initXHR",value:function(){h(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"initXHR",this).call(this),this.xhr.responseType="text",this.xhr.overrideMimeType("text/plain; charset=x-user-defined")}},{key:"onXHRProgress",value:function(){var a=this.xhr.responseText.slice(this.bytesRead);a.length>0&&(this.bytesRead+=a.length,this.emit("buffer",a))}},{key:"onXHRLoad",value:function(){this.onXHRProgress(),h(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"onXHRLoad",this).call(this)}}]),b}(i);j.supported=function(){try{var a=new XMLHttpRequest;return!!a.overrideMimeType}catch(a){return!1}},b.exports=j},{"./download-backend.js":4}],4:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},i=a("./backend.js"),j=function(a){function b(){return d(this,b),e(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return f(b,a),g(b,[{key:"bufferToOffset",value:function(a){var b=this;return new Promise(function(c,d){b.eof||b.offset>=a?c():!function(){var e=null;b._onAbort=function(a){e(),d(a)};var f=function(){b.offset>=a&&!b.eof&&(e(),c())},g=function(){e(),c()},h=function(){e(),d(new Error("error streaming"))};e=function(){b.buffering=!1,b.off("buffer",f),b.off("done",g),b.off("error",h),b._onAbort=null},b.buffering=!0,b.on("buffer",f),b.on("done",g),b.on("error",h)}()})}},{key:"initXHR",value:function(){h(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"initXHR",this).call(this)}},{key:"onXHRStart",value:function(){var a=this;this.xhr.addEventListener("progress",function(){return a.onXHRProgress()}),this.xhr.addEventListener("error",function(){return a.onXHRError()}),this.xhr.addEventListener("load",function(){return a.onXHRLoad()}),this.emit("open")}},{key:"onXHRProgress",value:function(){throw new Error("abstract")}},{key:"onXHRError",value:function(){this.emit("error")}},{key:"onXHRLoad",value:function(){this.eof=!0,this.emit("done")}}]),b}(i);b.exports=j},{"./backend.js":2}],5:[function(a,b,c){"use strict";function d(){return f.supported()?f:h.supported()?h:g.supported()?g:null}function e(a){if(a.progressive===!1)return new i(a);if(j||(j=d()),!j)throw new Error("No supported backend class");return new j(a)}var f=a("./moz-chunked-backend.js"),g=a("./msstream-backend.js"),h=a("./binary-string-backend.js"),i=a("./arraybuffer-backend.js"),j=null;b.exports=e},{"./arraybuffer-backend.js":1,"./binary-string-backend.js":3,"./moz-chunked-backend.js":6,"./msstream-backend.js":7}],6:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},i=a("./download-backend.js"),j="moz-chunked-arraybuffer",k=function(a){function b(){return d(this,b),e(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return f(b,a),g(b,[{key:"initXHR",value:function(){h(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"initXHR",this).call(this),this.xhr.responseType=j}},{key:"onXHRProgress",value:function(){var a=this.xhr.response;this.bytesRead+=a.byteLength,this.emit("buffer",a)}}]),b}(i);k.supported=function(){try{var a=new XMLHttpRequest;return a.responseType=j,a.responseType===j}catch(a){return!1}},b.exports=k},{"./download-backend.js":4}],7:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},i=a("./backend.js"),j="ms-stream",k=function(a){function b(a){d(this,b);var c=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return c.stream=null,c.streamReader=null,c}return f(b,a),g(b,[{key:"initXHR",value:function(){h(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"initXHR",this).call(this),this.xhr.responseType=j}},{key:"onXHRStart",value:function(){var a=this,b=function b(){3===a.xhr.readyState&&(a.stream=a.xhr.response,a.xhr.removeEventListener("readystatechange",b),a.emit("open"))};this.xhr.addEventListener("readystatechange",b)}},{key:"waitForStream",value:function(){var a=this;return new Promise(function(b,c){a.stream?b(a.stream):!function(){var d=null;a._onAbort=function(a){d(),c(a)};var e=function(){b(a.stream)};d=function(){a.off("open",e),a._onAbort=null},a.on("open",e)}()})}},{key:"bufferToOffset",value:function(a){var b=this;return this.waitForStream().then(function(c){return new Promise(function(d,e){if(b.streamReader)throw new Error("cannot trigger read when reading");if(b.offset>=a||b.eof)d();else{var f=a-b.offset;b.streamReader=new MSStreamReader,b.streamReader.onload=function(a){b.streamReader=null;var c=a.target.result;c.byteLength>0?(b.bytesRead+=c.byteLength,b.emit("buffer",c)):(b.eof=!0,b.emit("done")),d()},b.streamReader.onerror=function(){b.streamReader=null,b.stream=null,b.emit("error"),e(new Error("mystery error streaming"))},b._onAbort=function(a){b.streamReader.abort(),b.streamReader=null,b.stream=null,b.emit("error"),e(a)},b.streamReader.readAsArrayBuffer(c,f)}})})}},{key:"abort",value:function(){this.streamReader&&(this.streamReader.abort(),this.streamReader=null),this.stream&&(this.stream.msClose(),this.stream=null),h(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"abort",this).call(this)}}]),b}(i);k.supported=function(){try{var a=new XMLHttpRequest;return a.open("GET","/robots.txt"),a.responseType=j,a.responseType===j}catch(a){return!1}},b.exports=k},{"./backend.js":2}],8:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=function(){function a(){var b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},c=b.buffer,e=void 0===c?void 0:c,f=b.string,g=void 0===f?void 0:f,h=b.start,i=void 0===h?0:h,j=b.end,k=void 0===j?i+(e?e.byteLength:g?g.length:0):j,l=b.prev,m=void 0===l?null:l,n=b.next,o=void 0===n?null:n,p=b.eof,q=void 0!==p&&p,r=b.empty,s=void 0===r?!(e||g):r,t=b.timestamp,u=void 0===t?Date.now():t;d(this,a),this.start=i,this.end=k,this.prev=m,this.next=o,this.eof=q,this.empty=s,this.timestamp=u,this.buffer=e,this.string=g,Object.defineProperty(this,"length",{get:function(){return this.end-this.start}})}return e(a,[{key:"contains",value:function(a){return a>=this.start&&(a<this.end||this.eof)}},{key:"readBytes",value:function(a,b,c){var d=b-this.start,e=c-b;if(this.buffer){var f=new Uint8Array(this.buffer,d,e);a.set(f)}else{if(!this.string)throw new Error("invalid state");for(var g=this.string,h=0;h<e;h++)a[h]=g.charCodeAt(d+h)}this.timestamp=Date.now()}},{key:"split",value:function(b){if(!this.empty||!this.contains(b))throw new Error("invalid split");var c=new a({start:this.start,end:b}),d=new a({start:b,end:this.eof?b:this.end,eof:this.eof});return c.next=d,d.prev=c,[c,d]}},{key:"first",value:function(a){for(var b=this;b;b=b.next)if(a(b))return b;return null}},{key:"last",value:function a(b){for(var a=null,c=this;c&&b(c);c=c.next)a=c;return a}}]),a}();b.exports=f},{}],9:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=a("./cache-item.js"),g=function(){function a(){var b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},c=b.cacheSize,e=void 0===c?0:c;d(this,a);var g=new f({eof:!0});this.head=g,this.tail=g,this.readOffset=0,this.readCursor=g,this.writeOffset=0,this.writeCursor=g,this.cacheSize=e}return e(a,[{key:"bytesReadable",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1/0,b=this.readOffset,c=this.readCursor,d=c.last(function(c){return!c.empty&&c.start<=b+a});return d?Math.min(a,d.end-b):0}},{key:"bytesWritable",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1/0,b=this.writeOffset,c=this.writeCursor;if(c.eof)return a;var d=c.last(function(c){return c.empty&&c.start<=b+a});return d?Math.min(a,d.end-b):0}},{key:"seekRead",value:function(a){var b=this.head.first(function(b){return b.contains(a)});if(!b)throw new Error("read seek out of range");this.readOffset=a,this.readCursor=b}},{key:"seekWrite",value:function(a){var b=this.head.first(function(b){return b.contains(a)});if(!b)throw new Error("write seek out of range");this.writeOffset=a,this.writeCursor=b}},{key:"readBytes",value:function(a){for(var b=a.byteLength,c=this.bytesReadable(b),d=this.readOffset,e=d+c,f=d,g=this.readCursor;g&&!g.empty&&!(g.start>=e);g=g.next){var h=Math.min(e,g.end),i=a.subarray(f-d,h-d);g.readBytes(i,f,h),f=h}return this.readOffset=f,this.readCursor=this.readCursor.first(function(a){return a.contains(f)}),c}},{key:"write",value:function(a){var b=this.bufferItem(a),c=this.writeCursor;if(!c.empty)throw new Error("write cursor not empty");if(!c.contains(b.end)&&c.end!==b.end)throw new Error("write cursor too small");c.start<b.start&&(this.split(c,b.start),c=this.writeCursor),(b.end<c.end||c.eof)&&(this.split(c,b.end),c=this.writeCursor),this.splice(c,c,b,b),this.writeOffset=b.end,this.writeCursor=b.next,this.gc()}},{key:"bufferItem",value:function(a){if(a instanceof ArrayBuffer)return new f({start:this.writeOffset,end:this.writeOffset+a.byteLength,buffer:a});if("string"==typeof a)return new f({start:this.writeOffset,end:this.writeOffset+a.length,string:a});throw new Error("invalid input to write")}},{key:"split",value:function(a,b){var c=a.split(b);this.splice(a,a,c[0],c[1])}},{key:"ranges",value:function a(){for(var a=[],b=this.head;b;b=b.next)if(!b.empty){var c=b;b=b.last(function(a){return!a.empty}),a.push([c.start,b.end])}return a}},{key:"gc",value:function(){for(var a=0,b=[],c=this.head;c;c=c.next)c.empty||(a+=c.length,(c.end<this.readOffset||c.start>this.readOffset+this.chunkSize)&&b.push(c));if(a>this.cacheSize){b.sort(function(a,b){return a.timestamp-b.timestamp});for(var d=0;d<b.length;d++){var e=b[d];if(a<=this.cacheSize)break;this.remove(e),a-=e.length}}}},{key:"remove",value:function(a){var b=new f({start:a.start,end:a.end});this.splice(a,a,b,b),a=b,a.prev&&a.prev.empty&&(a=this.consolidate(a.prev)),a.next&&a.next.empty&&!a.next.eof&&(a=this.consolidate(a)),0===a.start&&(this.head=a)}},{key:"consolidate",value:function(a){var b=a.last(function(a){return a.empty&&!a.eof}),c=new f({start:a.start,end:b.end});return this.splice(a,b,c,c),c}},{key:"splice",value:function(a,b,c,d){var e=this;if(a.start!==c.start)throw new Error("invalid splice head");if(!(b.end===d.end||b.eof&&d.eof))throw new Error("invalid splice tail");var f=a.prev,g=b.next;a.prev=null,b.next=null,f&&(f.next=c,c.prev=f),g&&(g.prev=d,d.next=g),a===this.head&&(this.head=c),b===this.tail&&(this.tail=d),this.readCursor=this.head.first(function(a){return a.contains(e.readOffset)}),this.writeCursor=this.head.first(function(a){return a.contains(e.writeOffset)})}},{key:"eof",get:function(){return this.readCursor.eof}}]),a}();b.exports=g},{"./cache-item.js":8}],10:[function(a,b,c){"use strict";b.exports=a("./cache-pool.js")},{"./cache-pool.js":9}],11:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=function(){function a(){d(this,a),this._e={}}return e(a,[{key:"on",value:function(a,b){(this._e[a]||(this._e[a]=[])).push(b)}},{key:"off",value:function(a,b){var c=this._e[a]||[],d=c.indexOf(b);b>=0&&c.splice(d,1)}},{key:"emit",value:function(a,b){(this._e[a]||[]).slice().forEach(function(a){return a(b)})}}]),a}();b.exports=f},{}],12:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=(a("./events"),a("./cache")),g=a("./backend"),h=function(){function a(b){var c=b.url,e=void 0===c?"":c,g=b.chunkSize,h=void 0===g?1048576:g,i=b.cacheSize,j=void 0===i?0:i,k=b.progressive,l=void 0===k||k;d(this,a),this.length=-1,this.loaded=!1,this.loading=!1,this.seekable=!1,this.buffering=!1,this.seeking=!1,this.progressive=l,Object.defineProperties(this,{offset:{get:function(){return this._cache.readOffset}},eof:{get:function(){return this.length===this._cache.readOffset}}}),this.url=e,this.headers={},this._cache=new f({cacheSize:j}),this._backend=null,this._cachever=0,this._chunkSize=h}return e(a,[{key:"load",value:function(){var a=this;return new Promise(function(b,c){if(a.loading)throw new Error("cannot load when loading");if(a.loaded)throw new Error("cannot load when loaded");a.loading=!0,a._openBackend().then(function(c){a.seekable=c.seekable,a.headers=c.headers,a.length=c.length,a.loaded=!0,a.loading=!1,b()}).catch(function(b){"AbortError"!==b.name&&(a.loading=!1),c(b)})})}},{key:"_openBackend",value:function(){var a=this;return new Promise(function(b,c){if(a._backend)b(a._backend);else if(a.eof)c(new Error("cannot open at end of file"));else{var d=a._cache,e=a._chunkSize,f=d.bytesReadable(e),h=d.readOffset+f;if(d.seekWrite(h),a.length>=0&&h>=a.length)return void b(null);var i=a._clampToLength(d.writeOffset+d.bytesWritable(e))-d.writeOffset;0===i?b(null):!function(){var d=a._backend=new g({url:a.url,offset:a._cache.writeOffset,length:i,cachever:a._cachever,progressive:a.progressive}),e=null,f=function(){d!==a._backend?(e(),c(new Error("invalid state"))):(d.on("buffer",function(b){d===a._backend&&a._cache.write(b)}),d.on("done",function(){d===a._backend&&(a.length===-1&&(a.length=a._backend.offset+a._backend.bytesRead),a._backend=null)}),b(d))},h=function(b){d!==a._backend?c(new Error("invalid state")):(a._backend=null,c(b))};e=function(){d.off("open",f),d.off("error",h)},d.on("open",f),d.on("error",h),d.on("cachever",function(){a._cachever++}),d.load()}()}})}},{key:"_readAhead",value:function(){var a=this;return new Promise(function(b,c){a._backend||a.eof?b():a._openBackend().then(function(){b()}).catch(function(a){c(a)})})}},{key:"seek",value:function(a){var b=this;return new Promise(function(c,d){if(!b.loaded||b.buffering||b.seeking)throw new Error("invalid state");if(a!==(0|a)||a<0)throw new Error("invalid input");if(b.length>=0&&a>b.length)throw new Error("seek past end of file");if(!b.seekable)throw new Error("seek on non-seekable stream");b._backend&&b.abort(),b._cache.seekRead(a),b._cache.seekWrite(a),b._readAhead().then(c).catch(d)})}},{key:"read",value:function(a){var b=this;return this.buffer(a).then(function(a){return b.readSync(a)})}},{key:"readSync",value:function(a){var b=this.bytesAvailable(a),c=new Uint8Array(b),d=this.readBytes(c);if(d!==b)throw new Error("failed to read expected data");return c.buffer}},{key:"readBytes",value:function(a){if(!this.loaded||this.buffering||this.seeking)throw new Error("invalid state");if(!(a instanceof Uint8Array))throw new Error("invalid input");var b=this._cache.readBytes(a);return this._readAhead(),b}},{key:"buffer",value:function(a){var b=this;return new Promise(function(c,d){if(!b.loaded||b.buffering||b.seeking)throw new Error("invalid state");if(a!==(0|a)||a<0)throw new Error("invalid input");var e=b._clampToLength(b.offset+a),f=e-b.offset,g=b.bytesAvailable(f);g>=f?c(g):(b.buffering=!0,b._openBackend().then(function(c){return c?c.bufferToOffset(e).then(function(){return b.buffering=!1,b.buffer(a)}):Promise.resolve(g)}).then(function(a){b.buffering=!1,c(a)}).catch(function(a){"AbortError"!==a.name&&(b.buffering=!1),d(a)}))})}},{key:"bytesAvailable",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1/0;return this._cache.bytesReadable(a)}},{key:"abort",value:function(){this.loading&&(this.loading=!1),this.buffering&&(this.buffering=!1),this.seeking&&(this.seeking=!1),this._backend&&(this._backend.abort(),this._backend=null)}},{key:"getBufferedRanges",value:function(){return this._cache.ranges()}},{key:"_clampToLength",value:function(a){return this.length<0?a:Math.min(this.length,a)}}]),a}();b.exports=h},{"./backend":5,"./cache":10,"./events":11}]},{},[12])(12)});
//# sourceMappingURL=stream-file.min.js.map